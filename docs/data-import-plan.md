# CSV → DB 임포트 계획

## 1. 원본 CSV 구조 메모
- 파일: `/mnt/c/Users/jaekw/Downloads/시간표 - 시간표 9월 29일 이후(진행중).csv`
- 열 개수: 10개 (0~9 index)
  - `0`: 시간대 (`2:00`, `3:30`, ...). 이후 행에서 비어 있으면 직전 시간대 유지.
  - `1`: 담당 선생님 + 강의실 정보 (줄바꿈으로 분리됨). 예: `"정\n3-A"` → 선생님 `정`, 강의실 `3-A`.
  - `2~7`: 월~토 요일별 수업 내용. 줄바꿈 + 쉼표로 학생명이 섞여 있음.
  - `8, 9`: 추가 슬롯(같은 시간대에 병행되는 다른 반)으로 추정. `8`은 선생님, `9`는 해당 반 상세.
- 첫 번째 헤더 행: `['9월', '담당\n선생님', '29(월)', '30(화)', ...]`
  - 날짜/요일 문자열에서 요일을 추출해 DB의 `day_of_week` (0=월 ~ 6=일)로 매핑할 예정.

## 2. 파싱 로직 초안
1. `Papa.parse`(프론트) 또는 `csv-parse`(서버)로 CSV를 UTF-8로 읽어옵니다.
2. 첫 번째 행은 헤더로 저장 → 요일/날짜 매핑 테이블 구성.
3. 각 행을 순회하면서
   - `row[0]`이 비어 있지 않으면 `currentTime = row[0]` 업데이트.
   - `row[1]`을 `\n`으로 분리 → `[teacherName, classroom?]` 식으로 나눔.
   - 요일 열(`row[2]~row[7]`) 각각에 대해 내용이 있으면
     - 문자열을 `\n` 기준으로 먼저 split → 제목/학생목록 분리.
     - 학생 목록은 쉼표 기준으로 split + trim → 배열로 저장.
     - DB `schedule_entries`에 `{ template_id, day_of_week, time_label: currentTime, teacherName, classroom, studentNamesRaw, notes }` 형태로 생성.
   - `row[8]`, `row[9]`도 값이 있으면 별도 `extra` 슬록으로 동일한 방식으로 저장 (day_of_week는 우선 비워두고 `notes`에 저장) → 이후 실제 의미 파악 후 요일 할당.
4. 반복 중 비어 있는 줄은 건너뛰고, `currentTime`/`teacherName`/`classroom`을 유지합니다.

## 3. DB 저장 전략
- `template_id`는 임포트 대상 템플릿(예: "2024-09-29 정규")을 사전에 만들고 그 ID를 사용.
- 기존 `schedule_entries`는 임포트 전에 삭제한 뒤 전체를 새로 INSERT (트랜잭션 처리).
- 학생명은 우선 `student_names` TEXT 컬럼에 `','`로 join해서 저장.
  - 추후 학생 DB가 준비되면 이 데이터를 사용해 학생 테이블을 채우고 관계 테이블로 분리 예정.
- 교실/비고는 `notes`에 JSON 문자열(`{"classroom":"3-A","raw":...}`) 형태로 저장하면 확장성이 좋음.

## 4. 추가 확인 포인트
- 열 8,9의 정확한 의미: 두 번째 캠퍼스인지, 비고인지 → 원장님 확인 후 처리 분기.
- 일요일 데이터가 다른 시트에 있는지 확인 필요. (현재 CSV에는 토요일까지만 존재.)
- CSV 내 공백/테스트 학생(`(테스트요일)`) 문구 정리 방식 결정.

## 5. 구현 현황 (2025-10-03)
1. `POST /api/templates/:id/import` (manager 이상) 엔드포인트가 CSV 업로드를 지원합니다.
   - `mode=replace` (기본값) / `mode=append` 로 저장 방식을 선택할 수 있습니다.
   - 헤더는 `시간, 담당 선생님, 월, 화, 수, 목, 금, 토, 일` 순서가 아니면 400 에러와 함께 상세 메시지를 돌려줍니다.
   - 셀의 첫 줄은 메모(반/교재), 이후 줄은 학생명(쉼표 구분)으로 인식하며 학생 뒤에 `[색상hex]`를 붙이면 색상 정보로 저장됩니다.
2. 프론트엔드 `CSV 업로드` 모달에서 헤더 검증을 사전 수행하고, 실패 시 업로드를 막으며 친절한 안내 문구를 제공합니다.
3. 샘플 템플릿 (`client/public/templates/sample-schedule-template.csv`)을 업데이트해 색상 표기(`[이름[#HEX]]`)와 메모 → 학생 순서를 그대로 참고할 수 있습니다.
4. `GET /api/templates/:id/export` 엔드포인트를 통해 언제든 현재 템플릿을 CSV로 내려받을 수 있고, UI에도 `CSV 다운로드` 버튼을 연결했습니다.
5. `POST /api/templates/:id/validate-csv` 엔드포인트로 내보낸 CSV를 즉시 재파싱해 원본과 비교하는 검증 루틴을 추가했습니다. UI에서는 `CSV 검증` 버튼을 눌러 누락·추가·변경 건수를 바로 확인할 수 있습니다.
6. 업로드 결과는 총 셀 수, 시간대 수, 선생님 수, 경고 목록과 함께 응답합니다.

## 6. 남은 과제
- CSV 예시 템플릿을 `/docs` 또는 UI에서 직접 다운로드할 수 있도록 제공하기.
- 열 8,9(추가 슬롯)의 정확한 의미를 확인하고 자동 매핑 로직 확정하기.
- CSV 업로드 시 teacher 열이 비어 있는 행을 어떻게 처리할지(예: 자동 추정, 경고 강화) 정책 결정하기.
- 내보낸 CSV에서 색상 정보를 별도 컬럼으로 분리할지, 현재처럼 학생명 뒤에 `[색상]`으로 유지할지 정책 확정하기.
- 대량 데이터(400명 이상) 업로드 시 성능 검증 및 페이징/캐싱 보완.
